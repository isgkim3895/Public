<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‚¬ì¦ëª¨ íšŒì› ê´€ë¦¬ í”„ë¡œê·¸ë¨</title>
    <!-- Tailwind CSS ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts (Inter) ë¡œë“œ -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- ì•„ì´ì½˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* ê¸°ë³¸ í°íŠ¸ ì„¤ì • */
        body {
            font-family: 'Noto Sans KR', 'Inter', sans-serif;
        }
        /* ìŠ¤í¬ë¡¤ë°” ë””ìì¸ */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* ëª¨ë‹¬ ì• ë‹ˆë©”ì´ì…˜ */
        .modal-enter {
            opacity: 0;
            transform: scale(0.95);
        }
        .modal-enter-active {
            opacity: 1;
            transform: scale(1);
            transition: all 0.2s ease-out;
        }
        .modal-leave-active {
            opacity: 0;
            transform: scale(0.95);
            transition: all 0.2s ease-in;
        }
        
        /* ëª¨ë°”ì¼ í™”ë©´ì„ ìœ„í•œ ë°˜ì‘í˜• í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        @media screen and (max-width: 768px) {
            .responsive-table thead {
                display: none; /* ëª¨ë°”ì¼ì—ì„œ í…Œì´ë¸” í—¤ë” ìˆ¨ê¸°ê¸° */
            }
            .responsive-table tr {
                display: block;
                margin-bottom: 1rem;
                border: 1px solid #ddd;
                border-radius: 0.5rem;
                padding: 1rem;
                background-color: #fff;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            }
            .responsive-table td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 0.5rem 0;
                border-bottom: 1px solid #eee;
            }
            .responsive-table td:last-child {
                border-bottom: none;
            }
            .responsive-table td::before {
                content: attr(data-label); /* data-label ì†ì„±ê°’ìœ¼ë¡œ ë¼ë²¨ ìƒì„± */
                font-weight: 600;
                margin-right: 1rem;
                text-align: left;
            }
            .responsive-table td.actions {
                justify-content: flex-end; /* ê´€ë¦¬ ë²„íŠ¼ì„ ì˜¤ë¥¸ìª½ìœ¼ë¡œ ì •ë ¬ */
            }
             .responsive-table td.actions::before {
                content: ""; /* ê´€ë¦¬ ë¼ë²¨ì€ ìˆ¨ê¹€ */
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="container mx-auto p-4 sm:p-6 lg:p-8">
        <!-- í—¤ë” -->
        <header class="mb-6 flex flex-col sm:flex-row justify-between items-center gap-4">
            <h1 class="text-3xl font-bold text-gray-800">ğŸ•ºğŸ’ƒ ì‚¬ì¦ëª¨ íšŒì› ê´€ë¦¬</h1>
            <div class="w-full sm:w-auto flex items-center space-x-2">
                <div class="relative flex-grow">
                    <input type="text" id="searchInput" placeholder="ë‹‰ë„¤ì„ ê²€ìƒ‰..." class="w-full pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i data-lucide="search" class="w-5 h-5 text-gray-400"></i>
                    </div>
                </div>
                <button id="addMemberBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-200 flex items-center space-x-2 flex-shrink-0">
                    <i data-lucide="user-plus" class="w-5 h-5"></i>
                    <span class="hidden sm:inline">ì‹ ê·œ ë“±ë¡</span>
                </button>
            </div>
        </header>

        <!-- íšŒì› ëª©ë¡ í…Œì´ë¸” -->
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 responsive-table">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ë²ˆí˜¸</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ë‹‰ë„¤ì„</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ëª¨ì„ëª…</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ì§ì±…</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ì„±ë³„</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ëª…ì°°</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ê´€ë¦¬</th>
                    </tr>
                </thead>
                <tbody id="memberList" class="bg-white divide-y divide-gray-200 md:divide-y-0">
                    <!-- ë°ì´í„°ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì‚½ì…ë©ë‹ˆë‹¤. -->
                    <tr><td colspan="7" class="text-center py-10 text-gray-500">íšŒì› ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</td></tr>
                </tbody>
            </table>
        </div>
        <div id="totalMemberCount" class="mt-4 text-right text-sm text-gray-600 font-medium"></div>
    </div>

    <!-- íšŒì› ë“±ë¡/ìˆ˜ì • ëª¨ë‹¬ -->
    <div id="memberModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div id="modalContent" class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto modal-enter">
            <form id="memberForm" class="p-6">
                <h2 id="modalTitle" class="text-2xl font-bold mb-6">ì‹ ê·œ íšŒì› ë“±ë¡</h2>
                <input type="hidden" id="memberId">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="nickname" class="block text-sm font-medium text-gray-700">ë‹‰ë„¤ì„</label>
                        <input type="text" id="nickname" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                    <div>
                        <label for="gender" class="block text-sm font-medium text-gray-700">ì„±ë³„</label>
                        <select id="gender" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="ì‹ ì‚¬">ì‹ ì‚¬</option>
                            <option value="ìˆ™ë…€">ìˆ™ë…€</option>
                        </select>
                    </div>
                    <div>
                        <label for="meetingName" class="block text-sm font-medium text-gray-700">ëª¨ì„ëª…</label>
                        <select id="meetingName" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" required></select>
                    </div>
                    <div>
                        <label for="position" class="block text-sm font-medium text-gray-700">ì§ì±…</label>
                        <select id="position" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" required></select>
                    </div>
                    <div>
                        <label for="nameTag" class="block text-sm font-medium text-gray-700">ëª…ì°°</label>
                        <select id="nameTag" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></select>
                    </div>
                    <div>
                        <label for="nameTagColor" class="block text-sm font-medium text-gray-700">ëª…ì°°ìƒ‰</label>
                        <select id="nameTagColor" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></select>
                    </div>
                    <div class="md:col-span-2">
                        <label for="exemption" class="block text-sm font-medium text-gray-700">íšŒë¹„ ë©´ì œ</label>
                        <select id="exemption" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="">í•´ë‹¹ ì—†ìŒ</option>
                            <option value="ë©´ì œ">ë©´ì œ</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label for="notes" class="block text-sm font-medium text-gray-700">ë¹„ê³ </label>
                        <textarea id="notes" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" id="cancelBtn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300 transition">ì·¨ì†Œ</button>
                    <button type="submit" id="saveBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition">ì €ì¥</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDK ë¡œë“œ -->
    <script type="module">
        // Firebase v11.6.1 SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, setDoc, deleteDoc, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- ì„¤ì • ---
        // ì´ ë¶€ë¶„ì€ ê³µê°œëœ ì •ë³´ì´ë¯€ë¡œ ì•± ì½”ë“œì— í¬í•¨í•´ë„ ì•ˆì „í•©ë‹ˆë‹¤.
        const firebaseConfig = {
            apiKey: "AIzaSyA7e79DgiDuvjGQCQgZNm-WAijLsxtAgFM",
            authDomain: "sajeulmo-app.firebaseapp.com",
            projectId: "sajeulmo-app",
            storageBucket: "sajeulmo-app.firebasestorage.app",
            messagingSenderId: "1092211749893",
            appId: "1:1092211749893:web:cb6884f7f1cf93b27d986c",
            measurementId: "G-SZTQ83RM3B"
        };

        // --- ë°ì´í„° ì½”ë“œ ì •ì˜ ---
        const DATA_CODES = {
            meeting: {
                '111': 'ì¤‘ì•™', '112': 'ë¦¬ë“¬ëŒ„ìŠ¤', '113': 'ì •í†µì‚¬êµ', '114': 'ëŒ„ìŠ¤ìŠ¤í¬ì¸ ', '115': 'ì¼ì‚°', '116': 'ìˆ˜ì›', '117': 'ì¸ì²œ', '118': 'ë™ë¶€', '119': 'ì„œë¶€', '120': 'ë‚¨ë¶€', '121': 'ë¶ë¶€', '122': 'ë“±ì‚°', '123': 'ìŒë°©', '124': 'ì˜¨ë¼ì¸',
                '211': 'ëŒ€ì „', '212': 'ì¶©ë‚¨', '213': 'ëŒ€êµ¬', '214': 'ê²½ë¶', '215': 'í¬í•­', '216': 'ë¶€ì‚°', '217': 'ì œì£¼', '218': 'ì „ë¶', '219': 'ì „ë‚¨', '220': 'ê²½ë‚¨', '221': 'ìš¸ì‚°', '222': 'ê°•ì›', '223': 'ì¶©ë¶'
            },
            position: {
                '11': 'ì´íšŒì¥', '12': 'ìƒì„ê³ ë¬¸', '13': 'ë¶€íšŒì¥', '14': 'ì›¹ë§ˆìŠ¤í„°', '15': 'ê³ ë¬¸', '16': 'ìë¬¸', '17': 'íšŒì¥', '18': 'ì§€ì—­íšŒì¥', '19': 'ì´ë¬´', '20': 'ë¶€ì§€íšŒì¥', '21': 'ëŒ€ì¥', '22': 'ë¶€ëŒ€ì¥', '23': 'êµ­ì¥', '24': 'CJ', '25': 'ê²Œì‹œíŒì§€ê¸°', '26': 'ê³µì‹ì‚¬ë¶€'
            },
            nameTag: { '1': 'ì„ì›', '2': 'ìš´ì˜ì§„', '3': 'ì¢…ì´', '4': 'ë§Œë“¤ëŒ€ìƒ' },
            nameTagColor: { '16': 'ì½”ìŠ¤ëª¨ìŠ¤ìƒ‰', '23': 'ë…¸ë‘ìƒ‰', '25': 'ì—°ë‘ìƒ‰', '26': 'ì´ˆë¡ìƒ‰', '44': 'ë°”ë‹¤ìƒ‰', '45': 'íŒŒë‘ìƒ‰' }
        };

        // --- Firebase ì´ˆê¸°í™” ---
        let db, auth;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (e) {
            console.error("Firebase ì´ˆê¸°í™” ì˜¤ë¥˜:", e);
            document.getElementById('memberList').innerHTML = '<tr><td colspan="7" class="text-center py-10 text-red-500">Firebase ì„¤ì • ì˜¤ë¥˜. ì½˜ì†”(F12)ì„ í™•ì¸í•˜ì„¸ìš”.</td></tr>';
            if (e.message.includes("Invalid Firebase configuration")) {
                 alert("Firebase ì„¤ì •ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. ì½”ë“œì˜ firebaseConfig ë³€ìˆ˜ì— ì‹¤ì œ í”„ë¡œì íŠ¸ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            }
        }
        
        // --- ì „ì—­ ë³€ìˆ˜ ---
        const membersCollection = collection(db, "sajeulmo_members");
        let allMembers = []; // ì „ì²´ íšŒì› ë°ì´í„° ìºì‹œ

        // --- í•µì‹¬ ë¡œì§ ---

        // 'ì†Œê°œëŒ€ìƒ' ì½”ë“œ ê³„ì‚° í•¨ìˆ˜
        function calculateIntroductionTarget(meetingCode, positionCode) {
            if (meetingCode === '111' && positionCode === '11') return '1'; // ì´íšŒì¥
            if (meetingCode === '111' && positionCode === '12') return '2'; // ì¤‘ì•™ ìƒì„ê³ ë¬¸
            if (meetingCode === '111' && positionCode === '15') return '3'; // ì¤‘ì•™ê³ ë¬¸
            if (meetingCode === '111' && positionCode === '13') return '4'; // ì¤‘ì•™ ë¶€íšŒì¥
            if (meetingCode === '111' && positionCode === '16') return '5'; // ì¤‘ì•™ ìë¬¸ìœ„ì›
            if (meetingCode !== '111' && (positionCode === '15' || positionCode === '16')) return '6'; // ì§€ì—­ìë¬¸ê³ ë¬¸
            if (meetingCode === '111' && positionCode === '14') return '7'; // ì¤‘ì•™ì›¹ë§ˆìŠ¤í„°
            if (['17', '18', '19', '21', '23'].includes(positionCode)) return '8'; // ì§€ì—­íšŒì¥ ì´ë¬´
            if (['24', '25'].includes(positionCode)) return '9'; // ê²Œì‹œíŒì§€ê¸° ë°©ì†¡êµ­CJ
            if (positionCode === '26') return '10'; // ê³µì‹ì‚¬ë¶€
            return ''; // í•´ë‹¹ ì—†ìŒ
        }

        // íšŒì› ëª©ë¡ ë Œë”ë§ í•¨ìˆ˜
        function renderMemberList(members) {
            const memberListEl = document.getElementById('memberList');
            const totalCountEl = document.getElementById('totalMemberCount');
            
            if (members.length === 0) {
                // ëª¨ë°”ì¼ì—ì„œëŠ” tbodyë¥¼ ë¹„ìš°ê³ , ë°ìŠ¤í¬íƒ‘ì—ì„œëŠ” ì•ˆë‚´ ë©”ì‹œì§€ í‘œì‹œ
                memberListEl.innerHTML = '<tr class="hidden md:table-row"><td colspan="7" class="text-center py-10 text-gray-500">ë“±ë¡ëœ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                if (window.innerWidth < 768) {
                     memberListEl.innerHTML = '<div class="text-center py-10 text-gray-500">ë“±ë¡ëœ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                }
                totalCountEl.textContent = 'ì´ 0ëª…';
                return;
            }

            memberListEl.innerHTML = members.map(member => `
                <tr id="member-row-${member.id}" class="hover:bg-gray-50 transition-colors duration-150">
                    <td data-label="ë²ˆí˜¸" class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${member.userNo}</td>
                    <td data-label="ë‹‰ë„¤ì„" class="px-4 py-3 whitespace-nowrap text-sm font-semibold text-blue-600">${member.nickname}</td>
                    <td data-label="ëª¨ì„ëª…" class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">${DATA_CODES.meeting[member.meetingName] || 'ì•Œ ìˆ˜ ì—†ìŒ'}</td>
                    <td data-label="ì§ì±…" class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">${DATA_CODES.position[member.position] || 'ì•Œ ìˆ˜ ì—†ìŒ'}</td>
                    <td data-label="ì„±ë³„" class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">${member.gender}</td>
                    <td data-label="ëª…ì°°" class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full" style="background-color: ${getBgColor(member.nameTagColor)}; color: ${getTextColor(member.nameTagColor)};">
                          ${DATA_CODES.nameTag[member.nameTag] || ''}
                        </span>
                    </td>
                    <td data-label="ê´€ë¦¬" class="px-4 py-3 whitespace-nowrap text-sm font-medium actions">
                        <button class="edit-btn text-indigo-600 hover:text-indigo-900" data-id="${member.id}">ìˆ˜ì •</button>
                        <button class="delete-btn text-red-600 hover:text-red-900 ml-4" data-id="${member.id}">ì‚­ì œ</button>
                    </td>
                </tr>
            `).join('');

            totalCountEl.textContent = `ì´ ${members.length}ëª…`;
        }

        // ëª…ì°°ìƒ‰ì— ë”°ë¥¸ ë°°ê²½/í…ìŠ¤íŠ¸ ìƒ‰ìƒ ë°˜í™˜ í•¨ìˆ˜
        function getBgColor(colorCode) {
            const colors = { '16': '#F7CAC9', '23': '#FDFD96', '25': '#B2E2B2', '26': '#98FB98', '44': '#A2D2FF', '45': '#BDE0FE' };
            return colors[colorCode] || '#E5E7EB';
        }
        function getTextColor(colorCode) {
            const colors = { '16': '#7C2D12', '23': '#854D0E', '25': '#14532D', '26': '#14532D', '44': '#1E3A8A', '45': '#1E40AF' };
            return colors[colorCode] || '#374151';
        }

        // ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸°
        const memberModal = document.getElementById('memberModal');
        const modalContent = document.getElementById('modalContent');
        
        function openModal() {
            memberModal.classList.remove('hidden');
            setTimeout(() => modalContent.classList.add('modal-enter-active'), 10);
        }

        function closeModal() {
            modalContent.classList.remove('modal-enter-active');
            modalContent.classList.add('modal-leave-active');
            setTimeout(() => {
                memberModal.classList.add('hidden');
                modalContent.classList.remove('modal-leave-active');
            }, 200);
        }

        // í¼ ì´ˆê¸°í™” ë° ì˜µì…˜ ì±„ìš°ê¸°
        function setupForm() {
            const meetingSelect = document.getElementById('meetingName');
            const positionSelect = document.getElementById('position');
            const nameTagSelect = document.getElementById('nameTag');
            const nameTagColorSelect = document.getElementById('nameTagColor');

            const createOptions = (selectEl, data) => {
                selectEl.innerHTML = Object.entries(data).map(([code, name]) => `<option value="${code}">${name}</option>`).join('');
            };

            createOptions(meetingSelect, DATA_CODES.meeting);
            createOptions(positionSelect, DATA_CODES.position);
            createOptions(nameTagSelect, DATA_CODES.nameTag);
            createOptions(nameTagColorSelect, DATA_CODES.nameTagColor);
        }

        // ë‹¤ìŒ íšŒì›ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°
        async function getNextUserNo() {
            const q = query(membersCollection, orderBy("userNo", "desc"), limit(1));
            const querySnapshot = await getDocs(q);
            if (querySnapshot.empty) {
                return 1;
            }
            const lastMember = querySnapshot.docs[0].data();
            return (lastMember.userNo || 0) + 1;
        }

        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            setupForm();

            onAuthStateChanged(auth, user => {
                if (user) {
                    // ì‹¤ì‹œê°„ ë°ì´í„° ê°ì§€
                    onSnapshot(query(membersCollection, orderBy("userNo", "asc")), (snapshot) => {
                        allMembers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        renderMemberList(allMembers);
                    });
                } else {
                    signInAnonymously(auth).catch(error => {
                        console.error("ìµëª… ë¡œê·¸ì¸ ì‹¤íŒ¨:", error);
                        // ì‚¬ìš©ìê°€ ê°€ì¥ í”í•˜ê²Œ ê²ªëŠ” ì„¤ì • ì˜¤ë¥˜ì— ëŒ€í•œ êµ¬ì²´ì ì¸ ì•ˆë‚´ ì¶”ê°€
                        if (error.code === 'auth/configuration-not-found') {
                            alert("Firebase ìµëª… ë¡œê·¸ì¸ ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.\n\n[í•´ê²° ë°©ë²•]\n1. Firebase ì½˜ì†”ì—ì„œ 'Authentication'ìœ¼ë¡œ ì´ë™í•˜ì„¸ìš”.\n2. 'Sign-in method' íƒ­ì„ ì„ íƒí•˜ì„¸ìš”.\n3. 'ìµëª…'ì„ ì°¾ì•„ í™œì„±í™”í•˜ê³  ì €ì¥í•˜ì„¸ìš”.\n\nì„¤ì • í›„ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.");
                            document.getElementById('memberList').innerHTML = '<tr><td colspan="7" class="text-center py-10 text-red-500">Firebase ìµëª… ë¡œê·¸ì¸ì´ í™œì„±í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.<br>ì•ˆë‚´ì— ë”°ë¼ ì„¤ì •ì„ ì™„ë£Œí•œ í›„ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”.</td></tr>';
                        }
                    });
                }
            });

            // ì‹ ê·œ ë“±ë¡ ë²„íŠ¼
            document.getElementById('addMemberBtn').addEventListener('click', () => {
                document.getElementById('memberForm').reset();
                document.getElementById('modalTitle').textContent = 'ì‹ ê·œ íšŒì› ë“±ë¡';
                document.getElementById('memberId').value = '';
                openModal();
            });

            // ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼
            document.getElementById('cancelBtn').addEventListener('click', closeModal);
            memberModal.addEventListener('click', (e) => {
                if (e.target === memberModal) closeModal();
            });

            // í¼ ì œì¶œ (ì €ì¥)
            document.getElementById('memberForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = document.getElementById('memberId').value;

                const meetingCode = document.getElementById('meetingName').value;
                const positionCode = document.getElementById('position').value;
                
                const memberData = {
                    nickname: document.getElementById('nickname').value,
                    gender: document.getElementById('gender').value,
                    meetingName: meetingCode,
                    position: positionCode,
                    nameTag: document.getElementById('nameTag').value,
                    nameTagColor: document.getElementById('nameTagColor').value,
                    exemption: document.getElementById('exemption').value,
                    notes: document.getElementById('notes').value,
                    introductionTarget: calculateIntroductionTarget(meetingCode, positionCode)
                };

                try {
                    if (id) { // ìˆ˜ì •
                        const memberRef = doc(db, "sajeulmo_members", id);
                        await setDoc(memberRef, memberData, { merge: true });
                        alert('íšŒì› ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    } else { // ì‹ ê·œ ë“±ë¡
                        memberData.userNo = await getNextUserNo();
                        await addDoc(membersCollection, memberData);
                        alert('ì‹ ê·œ íšŒì›ì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    }
                    closeModal();
                } catch (error) {
                    console.error("ë°ì´í„° ì €ì¥ ì˜¤ë¥˜:", error);
                    alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                }
            });

            // ìˆ˜ì • ë° ì‚­ì œ ë²„íŠ¼ (ì´ë²¤íŠ¸ ìœ„ì„)
            document.getElementById('memberList').addEventListener('click', async (e) => {
                const target = e.target;
                const id = target.dataset.id;

                if (target.classList.contains('edit-btn')) {
                    const member = allMembers.find(m => m.id === id);
                    if (member) {
                        document.getElementById('modalTitle').textContent = 'íšŒì› ì •ë³´ ìˆ˜ì •';
                        document.getElementById('memberId').value = member.id;
                        document.getElementById('nickname').value = member.nickname;
                        document.getElementById('gender').value = member.gender;
                        document.getElementById('meetingName').value = member.meetingName;
                        document.getElementById('position').value = member.position;
                        document.getElementById('nameTag').value = member.nameTag;
                        document.getElementById('nameTagColor').value = member.nameTagColor;
                        document.getElementById('exemption').value = member.exemption;
                        document.getElementById('notes').value = member.notes;
                        openModal();
                    }
                }

                if (target.classList.contains('delete-btn')) {
                    const member = allMembers.find(m => m.id === id);
                    if (confirm(`'${member.nickname}' íšŒì›ì„ ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
                        try {
                            await deleteDoc(doc(db, "sajeulmo_members", id));
                            alert('íšŒì›ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                        } catch (error) {
                            console.error("ì‚­ì œ ì˜¤ë¥˜:", error);
                            alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                        }
                    }
                }
            });
            
            // ê²€ìƒ‰ ê¸°ëŠ¥
            document.getElementById('searchInput').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filteredMembers = allMembers.filter(member => 
                    member.nickname.toLowerCase().includes(searchTerm)
                );
                renderMemberList(filteredMembers);
            });
        });
    </script>
</body>
</html>
